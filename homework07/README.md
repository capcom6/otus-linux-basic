# Домашнее задание №7

Снять дамп обращения к веб-серверу, проанализировать пакеты (начиная с первого). Описать на примере снятого дампа, как устанавливается сессия TCP. Настроить в iptables policy DROP, прописать разрешения только на нужные порты и протоколы.

Цель: в результате выполнения ДЗ вы получите базовые навыки работы с iptables и tcpdump.

В данном задании тренируются навыки:

- анализ пакетов данных;
- фильтрация траффика;
- восстановление конфигурации фильтрации траффика после перезагрузки ОС.

Необходимо:

- собрать дамп пакетов с определенного IP и проанализовать их;
- проанализовать нужные порты назначения и адреса источников для дальнейшей фильтрации траффика;
- настроить разрешения в iptables;
- сделать автовосстановление правил фильтрации после перезагрузки ОС.

# Ход работы

Работа выполняется на CentOS 7.

## Установка tcpdump

Устанавливаем `tcpdump` из одноименного пакета:

```bash
sudo yum install tcpdump
```

## Демонстрация установки TCP-сессии

Для демонстрации процесса установки TCP-сессии соберем входящие и исходящие пакеты с порта 80: `sudo tcpdump -nnn port 80`. В дампе идет установка одновременно 2 соединений, обозначаемые "сессия 1" и "сессия 2". Сессии устанавливаются с разных портов клиента.

```
# Сессия 1. Входящий пакет с флагом SYN
15:53:35.729756 IP x.x.x.x.52922 > 100.115.220.1.80: Flags [S], seq 1585778847, win 65535, options [mss 1460,nop,wscale 6,nop,nop,TS val 609233876 ecr 0,sackOK,eol], length 0

# Сессия 1. Исходящий пакет с флагами SYN+ACK, подтверждающий прием SYN
15:53:35.729842 IP 100.115.220.1.80 > x.x.x.x.52922: Flags [S.], seq 418313262, ack 1585778848, win 28960, options [mss 1460,sackOK,TS val 2933079 ecr 609233876,nop,wscale 7], length 0

# Сессия 2. Входящий пакет с флагом SYN
15:53:35.729860 IP x.x.x.x.52923 > 100.115.220.1.80: Flags [S], seq 2961642557, win 65535, options [mss 1460,nop,wscale 6,nop,nop,TS val 609233876 ecr 0,sackOK,eol], length 0

# Сессия 2. Исходящий пакет с флагами SYN+ACK, подтверждающий прием SYN
15:53:35.729872 IP 100.115.220.1.80 > x.x.x.x.52923: Flags [S.], seq 3474778432, ack 2961642558, win 28960, options [mss 1460,sackOK,TS val 2933079 ecr 609233876,nop,wscale 7], length 0

# Сессия 1. Входящий пакет с флагом ACK, TCP-сессия установлена
15:53:35.831986 IP x.x.x.x.52922 > 100.115.220.1.80: Flags [.], ack 1, win 2058, options [nop,nop,TS val 609233975 ecr 2933079], length 0

# Сессия 2. Входящий пакет с флагом ACK, TCP-сессия установлена
15:53:35.832652 IP x.x.x.x.52923 > 100.115.220.1.80: Flags [.], ack 1, win 2058, options [nop,nop,TS val 609233977 ecr 2933079], length 0
```

С этого момента TCP-сессия установлена и возможна передача данных между клиентом и сервером по протоколу TCP/IP.

## Сбор дампа пакетов с определенного IP

Соберем 20 пакетов, принятых с адреса `$IPADDR` и запишем в файл для дальнейшего анализа:

```bash
sudo tcpdump 'src $IPADDR' -c 20 -w packets.pcap
```

Во время сбора дампа несколько раз откроем страницу веб-сервера с компьютера с адресом $IPADDR.

## Анализ сохраненного дампа

Загрузим сформинованный в ранее дамп для анализа. Используем флаги для вывода адресов и портов в цифровом виде и максимально подробной информации о пакете, для удобства просмотра используем утилиту `less`:

```bash
tcpdump -nnvvv -r packets.pcap | less
```

Фрагмент дампа:

```
05:47:17.948280 IP (tos 0x0, ttl 45, id 0, offset 0, flags [DF], proto TCP (6), length 52)
    176.59.140.185.6823 > 100.115.220.1.22: Flags [.], cksum 0x327f (correct), seq 1, ack 0, win 2047, options [nop,nop,TS val 595401984 ecr 1802298049], length 0
05:47:17.949961 IP (tos 0x0, ttl 45, id 0, offset 0, flags [DF], proto TCP (6), length 52)
    176.59.140.185.6823 > 100.115.220.1.22: Flags [.], cksum 0x31f7 (correct), seq 1, ack 124, win 2045, options [nop,nop,TS val 595401984 ecr 1802298063], length 0
05:47:19.787058 IP (tos 0x48, ttl 40, id 0, offset 0, flags [DF], proto TCP (6), length 529)
    176.59.140.185.49622 > 100.115.220.1.80: Flags [P.], cksum 0xd407 (correct), seq 507473999:507474476, ack 2847788231, win 2060, options [nop,nop,TS val 595403799 ecr 1802295528], length 477: HTTP, length: 477
        GET / HTTP/1.1
        Host: test.host
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:86.0) Gecko/20100101 Firefox/86.0
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
        Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
        Accept-Encoding: gzip, deflate
        Connection: keep-alive
        Upgrade-Insecure-Requests: 1
        If-Modified-Since: Sat, 27 Feb 2021 07:51:55 GMT
        If-None-Match: "b-5bc4ca8948c96"
        Cache-Control: max-age=0
```

Согласно дампу в 05:47:17.948280 по протоколу TCP/IP с адреса `176.59.140.185` и порта 6823 на адрес `100.115.220.1` порт 22 (SSH) пришел пакет с флагом "не фрагментировать" общей длиной 52 байта и длиной данных 0 байт.

Следующий пакет в 05:47:17.949961 аналогичен.

В 05:47:19.787058 по протоколу TCP/IP с адреса `176.59.140.185` и порта 49622 на адрес `100.115.220.1` порт 80 пришел пакет общей длинной 529 байт, в том числе 477 байт данных протокола HTTP.

HTTP-запрос содержит следующую информцию:

1. Запрос делается методом GET к корню веб-сайта по протоколу HTTP версии 1.1.
2. Запрос выполняется на имя (хост) `test.host`.
3. Для запроса используется браузер, идентифицирующий себя как `Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:86.0) Gecko/20100101 Firefox/86.0`.
4. В ответ на запрос ожидаются следующие типы содержимого: `text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8`.
5. Предпочитаемые языки в порядке уменьшения приоритета: `ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3`.
6. Поддерживаемые способы сжатия: `gzip, deflate`.
7. Указана опция сохранять соединение после отправки ответа.
8. Указана опция перейти на защищенный протокол, если поддерживается.
9. Клиент уже имеет в кэше данные, актуальные на `Sat, 27 Feb 2021 07:51:55 GMT`, сервер должен вернуь содержимое только если оно новее.
10. Клиент уже имеет в кэше данные с хэшем `b-5bc4ca8948c96`, сервер должен вернуть содержимое только если его хэш отличен от указанного.
11. Задается максимальное время актуальности содержимого в 0 секунд.

Таким образом, трафик поступает на порты 22 и 80 сервера. Соберем список всех портов, на которые поступали пакеты:

```bash
tcpdump -nnq -r packets.dump | grep -P " > 100.115.220.1.(\d+)" -o | cut -d. -f 5 | sort -n | uniq
```

Полученный список совпадает с результатами анализа дампа, входяшие пакеты приходят только на 22 и 80 порт.

Дополнительно проверим список прослушиваемых TCP портов командой `sudo ss -tlnp`:

```
State       Recv-Q Send-Q                                             Local Address:Port                                                            Peer Address:Port              
LISTEN      0      128                                                            *:111                                                                        *:*                   users:(("rpcbind",pid=573,fd=8))
LISTEN      0      128                                                            *:80                                                                         *:*                   users:(("nginx",pid=26798,fd=6),("nginx",pid=26797,fd=6))
LISTEN      0      128                                                            *:22                                                                         *:*                   users:(("sshd",pid=1072,fd=3))
LISTEN      0      100                                                    127.0.0.1:25                                                                         *:*                   users:(("master",pid=1046,fd=13))
LISTEN      0      70                                                          [::]:33060                                                                   [::]:*                   users:(("mysqld",pid=29079,fd=32))
LISTEN      0      128                                                         [::]:3306                                                                    [::]:*                   users:(("mysqld",pid=29079,fd=34))
LISTEN      0      128                                                         [::]:111                                                                     [::]:*                   users:(("rpcbind",pid=573,fd=11))
LISTEN      0      128                                                         [::]:80                                                                      [::]:*                   users:(("nginx",pid=26798,fd=7),("nginx",pid=26797,fd=7))
LISTEN      0      128                                                         [::]:8081                                                                    [::]:*                   users:(("httpd",pid=20535,fd=4),("httpd",pid=15748,fd=4),("httpd",pid=15747,fd=4),("httpd",pid=15746,fd=4),("httpd",pid=15745,fd=4),("httpd",pid=15744,fd=4),("httpd",pid=12487,fd=4))
LISTEN      0      128                                                         [::]:8082                                                                    [::]:*                   users:(("httpd",pid=20535,fd=6),("httpd",pid=15748,fd=6),("httpd",pid=15747,fd=6),("httpd",pid=15746,fd=6),("httpd",pid=15745,fd=6),("httpd",pid=15744,fd=6),("httpd",pid=12487,fd=6))
LISTEN      0      128                                                         [::]:8083                                                                    [::]:*                   users:(("httpd",pid=20535,fd=8),("httpd",pid=15748,fd=8),("httpd",pid=15747,fd=8),("httpd",pid=15746,fd=8),("httpd",pid=15745,fd=8),("httpd",pid=15744,fd=8),("httpd",pid=12487,fd=8))
LISTEN      0      128                                                         [::]:22                                                                      [::]:*                   users:(("sshd",pid=1072,fd=4))
LISTEN      0      100                                                        [::1]:25                                                                      [::]:*                   users:(("master",pid=1046,fd=14))
```

Среди полученного списка извне должны быть доступны только порты 22 и 80, порт 3306 должен быть доступен в рамках локальной сети с целью работы репликации MySQL, остальные порты используются в рамках локальных подключений.

## Настройка фильтрации трафика

Выполним настройку фильтрации трафика с помощью `iptables`:

```bash
yum install iptables-services
# разрешаем входящие подключения по loopback-интерфейсу
iptables -A INPUT -i lo -j ACCEPT
# разрешаем уже установленные соединения
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
# отклоняем пакеты с ошибками
iptables -A INPUT -m conntrack --ctstate INVALID -j DROP 
# разрешаем входящие подключения по SSH
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
# разрешаем входящие подключения по HTTP
iptables -A INPUT -p tcp --dport 80 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
# разрешаем подключения к MySQL только по локальной сети
iptables -A INPUT --source 10.0.1.0/24 -p tcp --dport 3306 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
# все остальные входящие пакеты отклоняем
iptables -P INPUT DROP
# все исходящие соединения разрешаем
iptables -P OUTPUT ACCEPT
# запускаем iptables
systemctl enable iptables && systemctl start iptables
```

## Сохранение настроек iptables

Выполненные в прошлом разделе настройки будут активны до перезагрузки ОС. Чтобы они применялись автоматически при загрузке ОС необходимо их сохранить в файл конфигурации. Сделать это можно, например, следующей командой.

```bash
# сохраняем настройки
service iptables save
```

При этом настройки будут сохранены в файл `/etc/sysconfig/iptables`, из которого и будут считаны при загрузке ОС.

Таким образом, в рамках данной работы был выполнен сбор дампа входящих пакетов, проанализированы некоторые из пакетов, выявлены службы, к котором необходим доступ извне и настроены соответствующие правила фильтрации.

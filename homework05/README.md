# Домашнее задание №5

Создать репозиторий на GitHub с конфигами веб-сервера (из задачи про настройку вебсервера), настроить авторизацию по ключу, настроить автодеполой конфигов на веб-сервер из репозитория.

Цель: в результате выполнения ДЗ вы получите базовые навыки работы с git и github.

В данном задании тренируются навыки:

- работы с системой упраления версиями;
- установка ПО на сервер, работа с файлами конфигурации;
- базовая работа с github.

Необходимо:

- установить git;
- создать репозиторий на github;
- добавить ключ для авторизации на github;
- авторизоваться по ключу на guthub.

# Ход работы

Работы выполняется на CentOS 7.

## Подготовка

Создадим репозиторий на github.com с именем otus-administrator-linux-basic-21 и настройками по-умолчанию. Созданный репозиторий доступен по адресу https://github.com/capcom6/otus-administrator-linux-basic-21

Установим клиент git и укажем информацию о пользователе:

```bash
sudo yum install git
git config --global user.email "***@hotbox.ru"
git config --global user.name "Aleksandr ***"
```

Для авторизации создадим новый ключ:

```bash
# создаем пару ключей с адресом электронной почты в комментарии, пароль вводим в интерактивном режиме
ssh-keygen -t ed25519 -C "***@hotbox.ru"
# запускаем в фоне агента авторизации
eval "$(ssh-agent -s)"
# добавляем сгенерированный закрытый ключ в хранилище агента, в процессе вводим пароль от закрытого ключа
ssh-add ~/.ssh/id_ed25519
# получаем содержимое открытого ключа для дальнейшего добавления в учетную запись GitHub
cat ~/.ssh/id_ed25519.pub
```

В настройках ключей на https://github.com/settings/keys добавляем новый SSH-ключ с именем OTUS и содержимым, полученным на прошлом шаге.

<img src="/images/github_public_key.png" alt="Добавленный публичный ключ"/>

## Работа с репозиторием

На сервере, где ранее был настроен Nginx и Apache, выполним следующие действия:

```bash
# перейдем в домашний каталог
cd
# создадим каталог для репозитория
mkdir otus-administrator-linux-basic-21 && cd otus-administrator-linux-basic-21
# инициализируем локальный репозиторий
git init
# добавим удаленный репозиторий, ключевой момент - использование SSH-подключения, а не HTTPS
git remote add origin git@github.com:capcom6/otus-administrator-linux-basic-21.git
# создадим README.md
touch README.md
# добавим все файлы в директории в индекс
git add .
# зафиксируем изменения с комментарием
git commit -m "Initial commit"
# передадим зафиксированные изменения в репозиторий на GitHub
git push origin master
# создаем каталоги для хранения файлов конфигурации
mkdir -p conf/nginx conf/httpd/conf.d conf/httpd/conf
# копируем файл конфигурации nginx
cp /etc/nginx/nginx.conf conf/nginx/
# копируем файлы конфигурации apache
cp /etc/httpd/conf.d/virtual.conf conf/httpd/conf.d/
cp /etc/httpd/conf/httpd.conf conf/httpd/conf/
# добавляем новые файлы в индекс
git add .
# фиксируем изменения
gir commit -m "Added: configs"
```

## Скрипт восстановления

Для настройки рабочей конфигурации на новом сервере был написан скрипт restore.sh. Данный скрипт не имеет параметров и при запуске от имени суперпользователя производит установку необходимых пакетов, копирование файлов конфигурации из локальной директории и запуск соответствующих демонов. В конце работы скрипт пробует установить соединение с nginx по порту 80. При запуске скрипта с любыми параметрами, например, -h, скрипт отображает справочную информацию.

В общем случае порядок использования скрипта следующий:

```bash
sudo yum -y install git
git clone git@github.com:capcom6/otus-administrator-linux-basic-21.git
cd otus-administrator-linux-basic-21
sudo ./restore.sh
```

Таким образом, данный скрипт позволяет за несколько простых команд восстановить исходную кофигурацию на новом сервере.
